box: golang
no-response-timeout: 15

build_and_publish:
  steps:

  - wercker/setup-go-workspace:
      package-dir: github.com/hashicorp/terraform

  # Container debugging loop
  # ------------------------
#   - script:
#       name: Press CTRL+C to exit
#       code: |
#         while true; do sleep 1; done
  # ------------------------

  - script:
      name: Build website
      code: |
        set -x

        apt-get update
        apt-get -y install nodejs zip

        curl -sSL https://rvm.io/mpapis.asc | gpg --import -
        curl -sSL https://get.rvm.io | bash -s stable 
        source /etc/profile.d/rvm.sh

        rvm install 2.3
        rvm --default use 2.3
        gem install --no-document bundler

        cd $GOPATH/src/github.com/hashicorp/terraform/website

        for f in $(find source -name "*.updated" -print); do
            d=$(dirname $f)
            filename=$(basename $f)
            dest=${filename%.updated}
            cp -f $f $d/$dest
        done

        bundle install
        bundle exec middleman build

        set +x
  
  - script:
      name: Build terraform binaries
      code: |
        set -x
        
        cd $GOPATH/src/github.com/hashicorp/terraform
        XC_OS="linux darwin windows" make bin

        mv ./pkg ./website/build
        find ./website/build/pkg -name "*.zip" -exec rm -f {} \;

        set +x

  - script:
      name: Deploy website
      code: |
        curl -L "https://cli.run.pivotal.io/stable?release=linux64-binary&source=github" | tar -zx -C /usr/local/bin

        cf login -a https://api.run.pivotal.io \
            -u "$CF_USER" -p "$CF_PASSWORD" \
            -o "$CF_ORG" -s "$CF_SPACE"

        cf push terraform -p ./website/build/ -b staticfile_buildpack
